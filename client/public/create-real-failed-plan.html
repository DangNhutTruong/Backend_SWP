<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Real Failed Plan</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .output { margin: 20px 0; padding: 10px; border: 1px solid #ccc; background: #f5f5f5; }
        .error { background: #ffebee; border-color: #f44336; }
        .success { background: #e8f5e9; border-color: #4caf50; }
    </style>
</head>
<body>
    <h1>Create Real Failed Plan in Database</h1>
    
    <div>
        <button onclick="createFailedPlan()">1. T·∫°o Failed Plan trong Database</button>
        <button onclick="createCompletedPlan()">2. T·∫°o Completed Plan trong Database</button>
        <button onclick="createOngoingPlan()">3. T·∫°o Ongoing Plan trong Database</button>
        <button onclick="checkUserPlans()">4. Ki·ªÉm tra Plans c·ªßa User</button>
        <button onclick="goToQuitPlanList()">5. M·ªü QuitPlanList</button>
        <button onclick="clearLogs()">6. Clear Logs</button>
    </div>
    
    <div id="output" class="output"></div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('output').innerHTML = '';
        }

        async function createFailedPlan() {
            try {
                log('üöÄ T·∫°o failed plan trong database...', 'info');
                
                // Get auth token
                const token = localStorage.getItem('nosmoke_token') || 
                             sessionStorage.getItem('nosmoke_token') ||
                             localStorage.getItem('auth_token') ||
                             sessionStorage.getItem('auth_token');
                
                if (!token) {
                    log('‚ùå Kh√¥ng t√¨m th·∫•y auth token. Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.', 'error');
                    return;
                }

                // Create plan data
                const planData = {
                    plan_name: 'K·∫ø ho·∫°ch test failed t·ª´ database',
                    initial_cigarettes: 15,
                    goal: 'Test failed plan functionality',
                    metadata: {
                        packPrice: 30000,
                        smokingYears: 7,
                        selectedPlanId: 2
                    },
                    total_weeks: 8,
                    is_active: false,
                    status: 'ongoing' // T·∫°o ongoing tr∆∞·ªõc, sau ƒë√≥ update th√†nh failed
                };

                // Step 1: Create plan
                const createResponse = await fetch('http://localhost:5000/api/quit-plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(planData)
                });

                if (!createResponse.ok) {
                    throw new Error(`Create failed: ${createResponse.statusText}`);
                }

                const createdPlan = await createResponse.json();
                const planId = createdPlan.data?.id || createdPlan.id;
                
                log(`‚úÖ Plan created with ID: ${planId}`, 'success');

                // Step 2: Update status to failed
                const updateResponse = await fetch(`http://localhost:5000/api/quit-plans/${planId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: 'failed' })
                });

                if (!updateResponse.ok) {
                    throw new Error(`Update failed: ${updateResponse.statusText}`);
                }

                const updatedPlan = await updateResponse.json();
                log(`‚úÖ Plan status updated to 'failed'`, 'success');
                log(`üìã Plan ID: ${planId} - Status: failed`, 'info');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function createCompletedPlan() {
            try {
                log('üöÄ T·∫°o completed plan trong database...', 'info');
                
                const token = localStorage.getItem('nosmoke_token') || 
                             sessionStorage.getItem('nosmoke_token') ||
                             localStorage.getItem('auth_token') ||
                             sessionStorage.getItem('auth_token');
                
                if (!token) {
                    log('‚ùå Kh√¥ng t√¨m th·∫•y auth token. Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.', 'error');
                    return;
                }

                const planData = {
                    plan_name: 'K·∫ø ho·∫°ch ho√†n th√†nh th√†nh c√¥ng',
                    initial_cigarettes: 20,
                    goal: 'Test completed plan functionality',
                    metadata: {
                        packPrice: 35000,
                        smokingYears: 10,
                        selectedPlanId: 3
                    },
                    total_weeks: 12,
                    is_active: false,
                    status: 'ongoing'
                };

                // Create plan
                const createResponse = await fetch('http://localhost:5000/api/quit-plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(planData)
                });

                if (!createResponse.ok) {
                    throw new Error(`Create failed: ${createResponse.statusText}`);
                }

                const createdPlan = await createResponse.json();
                const planId = createdPlan.data?.id || createdPlan.id;
                
                log(`‚úÖ Plan created with ID: ${planId}`, 'success');

                // Update to completed
                const updateResponse = await fetch(`http://localhost:5000/api/quit-plans/${planId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        status: 'completed',
                        completedDate: new Date().toISOString()
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error(`Update failed: ${updateResponse.statusText}`);
                }

                log(`‚úÖ Plan status updated to 'completed'`, 'success');
                log(`üìã Plan ID: ${planId} - Status: completed`, 'info');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function createOngoingPlan() {
            try {
                log('üöÄ T·∫°o ongoing plan trong database...', 'info');
                
                const token = localStorage.getItem('nosmoke_token') || 
                             sessionStorage.getItem('nosmoke_token') ||
                             localStorage.getItem('auth_token') ||
                             sessionStorage.getItem('auth_token');
                
                if (!token) {
                    log('‚ùå Kh√¥ng t√¨m th·∫•y auth token. Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.', 'error');
                    return;
                }

                const planData = {
                    plan_name: 'K·∫ø ho·∫°ch ƒëang th·ª±c hi·ªán',
                    initial_cigarettes: 12,
                    goal: 'Test ongoing plan functionality',
                    metadata: {
                        packPrice: 25000,
                        smokingYears: 5,
                        selectedPlanId: 1
                    },
                    total_weeks: 6,
                    is_active: true,
                    status: 'ongoing'
                };

                const createResponse = await fetch('http://localhost:5000/api/quit-plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(planData)
                });

                if (!createResponse.ok) {
                    throw new Error(`Create failed: ${createResponse.statusText}`);
                }

                const createdPlan = await createResponse.json();
                const planId = createdPlan.data?.id || createdPlan.id;
                
                log(`‚úÖ Ongoing plan created with ID: ${planId}`, 'success');
                log(`üìã Plan ID: ${planId} - Status: ongoing`, 'info');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function checkUserPlans() {
            try {
                log('üîç Ki·ªÉm tra plans c·ªßa user...', 'info');
                
                const token = localStorage.getItem('nosmoke_token') || 
                             sessionStorage.getItem('nosmoke_token') ||
                             localStorage.getItem('auth_token') ||
                             sessionStorage.getItem('auth_token');
                
                if (!token) {
                    log('‚ùå Kh√¥ng t√¨m th·∫•y auth token', 'error');
                    return;
                }

                const response = await fetch('http://localhost:5000/api/quit-plans/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed: ${response.statusText}`);
                }

                const data = await response.json();
                const plans = data.data || data;
                
                log(`üìã T√¨m th·∫•y ${plans.length} plans:`, 'success');
                plans.forEach(plan => {
                    log(`- ID: ${plan.id}, Name: ${plan.plan_name}, Status: ${plan.status}`, 'info');
                });

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function goToQuitPlanList() {
            window.open('/journey', '_blank');
            log('üîó M·ªü QuitPlanList trong tab m·ªõi', 'info');
        }

        // Check on page load
        window.onload = function() {
            log('üöÄ Page loaded. S·∫µn s√†ng t·∫°o failed plan th·ª±c trong database.', 'info');
        };
    </script>
</body>
</html>
